<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Review Itemized List</title>
<style>
  :root {
    --bg:#fafafa; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
    --green:#16a34a; --green-dark:#12843c; --locked:#9ca3af;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:760px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:22px}
  .header{display:flex;align-items:center;gap:14px;margin-bottom:10px}
  .logo{width:120px;height:auto}
  h1{margin:0;font-size:26px;font-weight:700;letter-spacing:.2px}

  .list{list-style:none;margin:14px 0 0;padding:0;border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .row{display:flex;align-items:flex-start;justify-content:space-between;padding:14px 16px;border-top:1px solid var(--border);background:#fff}
  .row:first-child{border-top:none}
  .left{display:flex;align-items:flex-start;gap:12px;min-width:0;flex:1}
  .qty{font-size:14px;color:var(--muted);width:28px;text-align:right}
  .price{font-weight:600}
  .hr{height:1px;background:var(--border);margin:14px 0}
  .total{display:flex;align-items:center;justify-content:space-between;font-size:18px;margin-top:8px}
  .approve{width:100%;margin-top:10px;padding:16px 18px;border:none;border-radius:999px;background:var(--green);color:#fff;font-weight:800;font-size:18px;cursor:pointer}
  .approve:disabled{opacity:.6;cursor:not-allowed}
  .approve:hover{background:var(--green-dark)}
  .foot{margin-top:8px;text-align:center;color:#9ca3af;font-size:12px}
  .err{display:none;background:#ffeaea;color:#b00020;border:1px solid #ffb3b3;padding:10px 12px;border-radius:12px;margin:10px 0}
  .loading{color:var(--muted);padding:8px 0}

  /* Toggle (iOS-style) */
  .switch{position:relative;display:inline-block;width:44px;height:26px;flex:0 0 44px;margin-top:2px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border:1px solid var(--border);transition:.2s;border-radius:999px}
  .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:2px;background:white;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.25);transition:.2s}
  .switch input:checked + .slider{background:var(--green)}
  .switch input:checked + .slider:before{transform:translateX(18px)}
  .switch.locked .slider{background:#eee;border-color:#ddd}
  .switch.locked .slider:before{background:#f5f5f5}

  /* One-line + ellipsis, with inline Show more/less */
  .descWrap{display:flex;align-items:center;gap:8px;min-width:0}
  .desc{
    flex:1 1 auto;
    font-size:16px; line-height:1.25;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .desc.expanded{ white-space:normal; }
  .show-toggle{
    flex:0 0 auto; font-size:12px; color:#6c757d; cursor:pointer; text-decoration:underline;
    display:inline;
  }

  /* ðŸ”’ Locked rows styling */
  .row.locked { opacity: .55; }
  .row.locked .desc { text-decoration: line-through; }
  .badge{font-size:11px;background:#f3f4f6;color:var(--locked);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <img class="logo" src="https://img1.wsimg.com/isteam/ip/0cb93133-3d57-42c9-a286-0e0545fb16eb/logo/2d820e52-be84-4b69-8711-0f17d2bf71d7.png" alt="Handyman Husbands" />
        <h1>Review Itemized List</h1>
      </div>

      <div id="err" class="err"></div>

      <ul id="list" class="list">
        <div class="loading" id="loading">Loading itemsâ€¦</div>
      </ul>

      <div class="hr"></div>

      <div class="total">
        <div><strong>Updated Total:</strong></div>
        <div id="total"><strong>$0.00</strong></div>
      </div>

      <!-- Minimum warning lives here -->
      <div id="min-warn" style="display:none;color:#b00020;font-size:14px;margin:6px 0 0 2px;"></div>

      <button id="approve" class="approve" disabled>Approve These Items</button>
      <div class="foot">Powered by Home Hero OS</div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const NEXT_PUBLIC_API_BASE = "https://estimate.handymanhusbands.com";   // your Node server origin
  const THANK_YOU_URL = "https://www.homeheroos.com/handyman-husbands/thank-you";
  // ====================

  const params  = new URLSearchParams(location.search);
  const estId   = params.get("id");
  const token   = params.get("token");

  const $list    = document.getElementById("list");
  const $total   = document.getElementById("total");
  const $btn     = document.getElementById("approve");
  const $err     = document.getElementById("err");
  const $loading = document.getElementById("loading");
  const $warn    = document.getElementById("min-warn");

  const state = { lines: [], selected: {}, approved: new Set() };
  let MIN_JOB = 129 * 100; // default to $129 unless server overrides

  function fmtUSD(n){ return "$" + n.toFixed(2); }

  function updateTotalUI(){
    const cents = state.lines.reduce((sum, l) => {
      // Locked items are already approved; theyâ€™re not part of this new approval
      if (state.approved.has(l.id)) return sum;
      return sum + (state.selected[l.id] ? l.amountCents : 0);
    }, 0);

    $total.innerHTML = "<strong>" + fmtUSD(cents/100) + "</strong>";

    if (cents < MIN_JOB) {
      $btn.disabled = true;
      $warn.textContent = `Minimum job is $${(MIN_JOB/100).toFixed(0)} for a technician to come out.`;
      $warn.style.display = "block";
    } else {
      $btn.disabled = false;
      $warn.style.display = "none";
    }
  }

  function makeRow(line){
    const li = document.createElement("li");
    li.className = "row";

    const left = document.createElement("div");
    left.className = "left";

    // Toggle switch
    const label = document.createElement("label");
    label.className = "switch";
    const input = document.createElement("input");
    input.type = "checkbox";

    const isApproved = state.approved.has(line.id);

    if (isApproved) {
      input.checked = false;           // locked items not included in NEW approval
      input.disabled = true;
      label.classList.add("locked");
      li.classList.add("locked");      // <-- grey row + strike-through
    } else {
      input.checked = !!state.selected[line.id];
      input.addEventListener("change", () => {
        state.selected[line.id] = input.checked;
        updateTotalUI();
      });
    }

    const slider = document.createElement("span");
    slider.className = "slider";
    label.appendChild(input);
    label.appendChild(slider);

    // One-line description with inline Show more/less
    const descWrap = document.createElement("div");
    descWrap.className = "descWrap";

    const desc = document.createElement("div");
    desc.className = "desc";
    desc.textContent = line.name;

    const toggle = document.createElement("span");
    toggle.className = "show-toggle";
    toggle.textContent = "Show more";
    toggle.onclick = () => {
      const expanded = desc.classList.toggle("expanded");
      toggle.textContent = expanded ? "Show less" : "Show more";
      if (!expanded) requestAnimationFrame(() => {
        if (desc.scrollWidth <= desc.clientWidth) toggle.style.display = "none";
      });
    };

    descWrap.appendChild(desc);
    descWrap.appendChild(toggle);

    left.appendChild(label);
    left.appendChild(descWrap);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.alignItems = "center";
    right.style.gap = "12px";

    if (isApproved) {
      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = "Locked";
      right.appendChild(badge);
    }

    const qty = document.createElement("div");
    qty.className = "qty";
    qty.textContent = line.qty ?? 1;

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = fmtUSD(line.amountCents/100);

    right.appendChild(qty);
    right.appendChild(price);

    li.appendChild(left);
    li.appendChild(right);

    // Hide "Show more" if not actually truncated
    requestAnimationFrame(() => {
      if (desc.scrollWidth <= desc.clientWidth) {
        toggle.style.display = "none";
      }
    });

    return li;
  }

  async function loadLines(){
    if(!estId || !token){
      $err.textContent = "Invalid link. Please request a new estimate link.";
      $err.style.display = "block";
      $loading?.remove();
      return;
    }
    try{
      const r = await fetch(`${API_BASE}/customize/lines?id=${encodeURIComponent(estId)}&token=${encodeURIComponent(token)}`);
      const d = await r.json();
      if(!d.ok) throw new Error(d.error || "Failed to load items.");

      if (d.minJobCents) MIN_JOB = d.minJobCents;

      state.lines = d.lines || [];
      state.approved = new Set((d.approvedLineIds || []).map(String));

      // Default ON only for items that are NOT approved/locked
      state.selected = Object.fromEntries(state.lines.map(l => [l.id, !state.approved.has(l.id)]));

      $list.innerHTML = "";
      state.lines.forEach(l => $list.appendChild(makeRow(l)));
      updateTotalUI();
    }catch(e){
      $err.textContent = e.message || "Could not load items.";
      $err.style.display = "block";
      $list.innerHTML = "";
    }
  }

  // APPROVE -> call server with QBO line indexes
  document.getElementById("approve").addEventListener("click", async () => {
    try{
      // Collect the QBO line INDEXES for items toggled ON and not locked
      const lineItemIds = state.lines
        .filter(l => !state.approved.has(l.id) && state.selected[l.id])
        .map(l => Number(l.id));

      if(lineItemIds.length === 0) return;

      $btn.disabled = true;

      const r = await fetch(`${API_BASE}/api/estimates/${encodeURIComponent(estId)}/customize`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ selectedLineIds: lineItemIds }) // must be "selectedLineIds"
      });

      const d = await r.json();
      if(!r.ok || !d.ok) throw new Error(d.error || "Unable to create child estimate.");

      // success -> thank you
      location.href = THANK_YOU_URL;
    }catch(e){
      $err.textContent = e.message || "Submit failed.";
      $err.style.display = "block";
      $btn.disabled = false;
    }
  });

  loadLines();
</script>
</body>
</html>
